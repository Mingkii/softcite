@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl:     <http://www.w3.org/2002/07/owl#> .

@prefix ca: <http://floss.syr.edu/ontologies/2008/4/contentAnalysis.owl#> .
@prefix doap: <http://usefulinc.com/ns/doap#> .

@prefix bioj: <http://james.howison.name/ontologies/bio-journal-sample#> .
@prefix citec: <http://james.howison.name/ontologies/software-citation-coding#> .
@prefix bioj-cited: <http://james.howison.name/ontologies/bio-journal-sample-citation#> .

@prefix dc: <http://dublincore.org/documents/2012/06/14/dcmi-terms/> .

@prefix sp:      <http://spinrdf.org/sp#> .
@prefix spin:    <http://spinrdf.org/spin#> .
@prefix spl:     <http://spinrdf.org/spl#> .

<http://james.howison.name/ontologies/software-citation-coding-constraints>
  rdf:type owl:Ontology ;
  owl:imports <http://purl.org/dc/terms/> ;
  owl:imports <http://spinrdf.org/spl> .

# Create a class of rules that run first.
# This is needed to do a if not true then false clean up on is_credited.
bioj:runFirstRule rdfs:subPropertyOf spin:rule ;
                  spin:nextRuleProperty spin:runSecondRule .
				  
bioj:runSecondRule rdfs:subPropertyOf spin:rule ;
                spin:nextRuleProperty spin:rule .				  

bioj:SoftwareMention a rdfs:Class ;

            bioj:runFirstRule [ rdf:type sp:Construct ;
			sp:text """
	# Try to find an existing SoftwarePackage (i.e. one from the Mapping File)
	CONSTRUCT {
	  ?software_package bioj:mentioned_in ?this .
	  ?this bioj:mentions_software ?software_package ;
	}
	WHERE {
	  ?this  rdf:type bioj:SoftwareMention ;
	  		 citec:original_name ?name .
	  ?software_package rdf:type bioj:SoftwarePackage .
	  { ?software_package rdfs:label ?name }
	  UNION
	  { ?software_package citec:alternative_name ?name }
	}"""
] ;
            bioj:runSecondRule [ rdf:type sp:Construct ;
			sp:text """
	# Create software packages for each non-alternative
	CONSTRUCT {
	  ?software_package a bioj:SoftwarePackage ;
	                    rdfs:label ?name ;
						bioj:mentioned_in ?this .
	  ?this bioj:mentions_software ?software_package ;

	}
	WHERE {
	  ?this  rdf:type bioj:SoftwareMention ;
	  		 citec:original_name ?name .
	  FILTER NOT EXISTS { ?this bioj:mentions_software ?software }
	  BIND (
		 URI(CONCAT("http://james.howison.name/ontologies/bio-journal-sample#software-",
		            ENCODE_FOR_URI(?name)
			       )
		    ) as ?software_package )
	}"""
] ;


            bioj:runSecondRule [ rdf:type sp:Construct ;
			sp:text """
	# Create ArticleSoftwareLinks
	CONSTRUCT {
	  ?article_software_link rdf:type bioj:ArticleSoftwareLink ;
	  	        bioj:mentions_software ?software_package ;
				bioj:from_article ?article ;
				bioj:from_mention ?this .
	  ?this bioj:article_software_link ?article_software_link .
	}
	WHERE {
	  ?this  rdf:type bioj:SoftwareMention ;
			 bioj:mentions_software ?software_package ;
			 bioj:from_selection ?selection .
	  ?software_package rdfs:label ?name .
	  ?article bioj:has_selection ?selection .
	   	  BIND (
	   		 URI(CONCAT("http://james.howison.name/ontologies/bio-journal-sample#",
	   		            REPLACE(str(?article), '^.*(#|/)', ""),
						"-",
						ENCODE_FOR_URI(?name)
	   			       )
	   		    ) as ?article_software_link )
	}"""
] ;
.

bioj:ArticleSoftwareLink a rdfs:Class ;

#####################
# Identifiable / Unidentifiable
####################

#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Move identifiable true code to ArticleSoftwareLink
# 	# True if any are true, but that is dealt with later.
# 	CONSTRUCT {
# 		?this citec:is_identifiable true .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		      bioj:from_mention ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{ {
# 			?sel 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:identifiable ] ] ;
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 			?ref 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:identifiable ] ] ;
# 		} } UNION {
# 			?sel bioj:references_same_software ?sel2 .
# 			?sel2 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:identifiable ] ] ;
# 		}
# 	}"""
# ] ;
#
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Move identifiable true code to ArticleSoftwareLink
# 	# True if any are true, but that is dealt with later.
# 	CONSTRUCT {
# 		?this citec:is_identifiable false .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		      bioj:from_mention ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{ {
# 			?sel 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:unidentifiable ] ] ;
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 			?ref 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:unidentifiable ] ] ;
# 		} } UNION {
# 			?sel bioj:references_same_software ?sel2 .
# 			?sel2 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:unidentifiable ] ] ;
# 		}
# 	}"""
# ] ;

#####################
# Findable / Unfindable
####################

#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Move findable true code to ArticleSoftwareLink
# 	CONSTRUCT {
# 		?this citec:is_findable true .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		      bioj:from_mention ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:findable ] ] ;
# 		} UNION {
# 			?sel  bioj:has_reference ?ref .
# 			?ref 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:findable ] ] ;
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Move findable false code to ArticleSoftwareLink
#
# 	CONSTRUCT {
# 		?this citec:is_findable false .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		      bioj:from_mention ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:unfindable ] ] ;
# 		} UNION {
# 			?sel  bioj:has_reference ?ref .
# 			?ref 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:unfindable ] ] ;
# 		}
# 	}"""
# ] ;
#
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# If any Mention for this Link includes version_indicator then this does too.
#
# 	CONSTRUCT {
# 		?this citec:has_version_indicator true .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		      bioj:from_mention ?mention .
# 		?mention citec:has_version_indicator true .
# 	}"""
# ] ;
#
# #This is the last rule to run (because it's not a bioj:runFirstRule)
#     spin:rule [ rdf:type sp:Construct ;
# 	sp:text """
# 	CONSTRUCT {
# 		?this citec:has_version_indicator false .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		FILTER NOT EXISTS { ?this citec:has_version_indicator true . }
# 	}"""
# ] ;
#
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Move findable true code to ArticleSoftwareLink
# 	CONSTRUCT {
# 		?this citec:version_is_findable true .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		      bioj:from_mention ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:findable_version ] ] ;
# 		} UNION {
# 			?sel  bioj:has_reference ?ref .
# 			?ref 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:findable_version ] ] ;
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Move findable false code to ArticleSoftwareLink
#
# 	CONSTRUCT {
# 		?this citec:version_is_findable false .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:ArticleSoftwareLink ;
# 		      bioj:from_mention ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:unfindable_version ] ] ;
# 		} UNION {
# 			?sel  bioj:has_reference ?ref .
# 			?ref 	ca:isTargetOf   [ ca:appliesCode [ rdf:type citec:unfindable_version ] ] ;
# 		}
# 	}"""
# ] ;


    bioj:runFirstRule [ rdf:type sp:Construct ;
		sp:text """
		# Interpret creator codes. True if any mentions had a creator.
		CONSTRUCT {
			?this citec:is_credited true .
		}
		WHERE {
			?this rdf:type bioj:ArticleSoftwareLink ;
			      bioj:from_mention ?mention .
			?mention citec:has_creator true .
		}"""
	] ;

	bioj:runSecondRule [ rdf:type sp:Construct ;
		sp:text """
		# Otherwise false
		CONSTRUCT {
			?this citec:is_credited false .
		}
		WHERE {
			?this rdf:type bioj:ArticleSoftwareLink .
			FILTER NOT EXISTS { ?this citec:is_credited true }
		}"""
	] ;
.




# bioj:SoftwarePackage a rdfs:Class ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Interpret software package codes
# 	CONSTRUCT {
# 		?this citec:is_accessible true ;
# 		      citec:is_free       true .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:SoftwarePackage ;
# 		      bioj:mentioned_in ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel ca:isTargetOf [ ca:appliesCode [ rdf:type citec:access_free ] ] .
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 	        ?ref ca:isTargetOf [ ca:appliesCode [ rdf:type citec:access_free ] ] .
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Interpret software package codes
# 	CONSTRUCT {
# 		?this citec:is_accessible true ;
# 		      citec:is_free       false .
# 	}
# 	WHERE {
# 		?this rdf:type bioj:SoftwarePackage ;
# 		      bioj:mentioned_in ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel ca:isTargetOf [ ca:appliesCode [ rdf:type citec:access_purchase ] ] .
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 	        ?ref ca:isTargetOf [ ca:appliesCode [ rdf:type citec:access_purchase ] ] .
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Interpret software package codes
# 	CONSTRUCT {
# 		?this citec:is_accessible false
# 	}
# 	WHERE {
# 		?this rdf:type bioj:SoftwarePackage ;
# 		      bioj:mentioned_in ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel ca:isTargetOf [ ca:appliesCode [ rdf:type citec:no_access ] ] .
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 	        ?ref ca:isTargetOf [ ca:appliesCode [ rdf:type citec:no_access ] ] .
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Interpret software package codes
# 	CONSTRUCT {
# 		?this citec:is_source_accessible true
# 	}
# 	WHERE {
# 		?this rdf:type bioj:SoftwarePackage ;
# 		      bioj:mentioned_in ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel ca:isTargetOf [ ca:appliesCode [ rdf:type citec:source_available ] ] .
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 	        ?ref ca:isTargetOf [ ca:appliesCode [ rdf:type citec:source_available ] ] .
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Interpret software package codes
# 	CONSTRUCT {
# 		?this citec:is_source_accessible false
# 	}
# 	WHERE {
# 		?this rdf:type bioj:SoftwarePackage ;
# 		      bioj:mentioned_in ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel ca:isTargetOf [ ca:appliesCode [ rdf:type citec:source_unavailable ] ] .
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 	        ?ref ca:isTargetOf [ ca:appliesCode [ rdf:type citec:source_unavailable ] ] .
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Interpret software package codes
# 	CONSTRUCT {
# 		?this citec:is_explicitly_modifiable true
# 	}
# 	WHERE {
# 		?this rdf:type bioj:SoftwarePackage ;
# 		      bioj:mentioned_in ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel ca:isTargetOf [ ca:appliesCode [ rdf:type citec:permission_modify ] ] .
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 	        ?ref ca:isTargetOf [ ca:appliesCode [ rdf:type citec:permission_modify ] ] .
# 		}
# 	}"""
# ] ;
#     bioj:runFirstRule [ rdf:type sp:Construct ;
# 	sp:text """
# 	# Interpret software package codes
# 	CONSTRUCT {
# 		?this citec:is_explicitly_modifiable false
# 	}
# 	WHERE {
# 		?this rdf:type bioj:SoftwarePackage ;
# 		      bioj:mentioned_in ?mention .
# 		?mention bioj:from_selection ?sel .
# 		{
# 			?sel ca:isTargetOf [ ca:appliesCode [ rdf:type citec:prohibited_modify ] ] .
# 		} UNION {
# 			?sel bioj:has_reference ?ref .
# 	        ?ref ca:isTargetOf [ ca:appliesCode [ rdf:type citec:prohibited_modify ] ] .
# 		}
# 	}"""
# ] ;
#
# .

